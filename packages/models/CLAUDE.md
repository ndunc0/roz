# @roz/models Package

## Overview
This package provides TypeScript models and database operation helpers for type-safe data access in the Roz project. It acts as an abstraction layer over the Supabase client, providing clean, typed interfaces for database operations.

## Package Structure
```
packages/models/
├── src/
│   ├── company-weekly-card.ts  # CompanyWeeklyCard model & operations
│   ├── index.ts                # Main package exports
│   └── dist/                   # Compiled JavaScript (generated)
├── package.json
└── tsconfig.json
```

## Models

### Company Weekly Card

The `company-weekly-card.ts` module provides types and operations for working with weekly company digest cards.

#### Types

**`CompanyWeeklyCard`**
- Full type for a company weekly card row from the database
- Derived from `Tables<'company_weekly_card'>` Supabase type
- Includes all fields: `card_id`, `company_id`, `week_id`, `headline`, `bullets_json`, `coverage_top`, `significance_max`, `source_context`, `version`, timestamps

**`CompanyWeeklyCardInsert`**
- Type for inserting a new company weekly card
- Derived from `TablesInsert<'company_weekly_card'>` with `card_id` omitted
- **Important**: Excludes `card_id` because it's auto-generated by the database as `company_id || '__' || week_id`
- Used when creating new cards to ensure type safety

#### Functions

**`createCompanyWeeklyCard(card: CompanyWeeklyCardInsert): Promise<CompanyWeeklyCard>`**
- Inserts a new company weekly card into the database
- Returns the created card with auto-generated `card_id`
- Throws error if insertion fails
- Uses `.select().single()` to return the inserted row

## Usage

### Installing Dependencies
This package depends on `@roz/supabase` for database types and client access.

```bash
npm install
```

### Basic Usage

```typescript
import { createCompanyWeeklyCard } from '@roz/models';
import type { CompanyWeeklyCard, CompanyWeeklyCardInsert } from '@roz/models';

// Prepare card data (using snake_case for database fields)
const cardData: CompanyWeeklyCardInsert = {
  company_id: 'factory-ai',
  week_id: '2025-W44',
  headline: 'Factory AI launches agentic platform + secures Series B',
  bullets_json: [
    '• Product launch — Factory AI released their autonomous agent platform for manufacturing',
    '• Funding — Raised $50M Series B led by Sequoia',
    '• Partnership — Signed deal with major automotive manufacturer'
  ],
  coverage_top: 'high',
  significance_max: 9,
  source_context: JSON.stringify({
    blogPosts: 2,
    linkedInUpdates: 3
  }),
  version: 1
  // card_id is auto-generated by database
};

// Insert the card
try {
  const card: CompanyWeeklyCard = await createCompanyWeeklyCard(cardData);
  console.log('Created card:', card.card_id);
  // Output: Created card: factory-ai__2025-W44
} catch (error) {
  console.error('Failed to create card:', error);
}
```

### Type Safety

The package ensures type safety by:
1. Using Supabase-generated types as the source of truth
2. Excluding auto-generated fields (`card_id`) from insert types
3. Providing typed return values from all functions

### Field Naming Conventions

**Database fields** (snake_case):
- `card_id`, `company_id`, `week_id`
- `bullets_json`, `coverage_top`, `significance_max`
- `source_context`, `created_at`, `updated_at`

**Application fields** (camelCase):
- When working in workflow/agent code, you may see: `cardId`, `companyId`, `weekId`
- The `@roz/models` package uses **snake_case** to match database column names
- If you need camelCase, perform the conversion at the application boundary

## Database Schema Notes

### Auto-generated card_id
The `card_id` field is a **GENERATED ALWAYS** column in the database:
```sql
card_id text GENERATED ALWAYS AS (company_id || '__' || week_id) STORED
```

This means:
- Do NOT provide `card_id` when inserting
- The database automatically generates it from `company_id` and `week_id`
- Example: `company_id='factory-ai'` + `week_id='2025-W44'` → `card_id='factory-ai__2025-W44'`

### Bullet Length Validation
The database enforces a 165-character limit per bullet point:
- This provides a 5-character buffer beyond the 160-character target
- Validation is enforced via the `bullet_lengths_valid()` function
- Insert will fail if any bullet exceeds 165 characters

### Coverage Top Values
The `coverage_top` field must be one of: `'high'`, `'medium'`, or `'low'`
- Enforced by database CHECK constraint
- Use lowercase values only

## Package Configuration

### ES Module Setup
```json
{
  "type": "module",
  "files": ["dist"]
}
```

- **`type: "module"`**: Enables ES module syntax (import/export) in Node.js
- **`files: ["dist"]`**: **Critical for Mastra deployment** - ensures compiled `dist/` folder is included when workspace package is bundled, overriding `.gitignore` exclusion

### Package Exports

```json
{
  ".": {
    "types": "./dist/index.d.ts",
    "default": "./dist/index.js"
  }
}
```

Import the package in your code:

```typescript
// Named imports
import {
  createCompanyWeeklyCard,
  type CompanyWeeklyCard,
  type CompanyWeeklyCardInsert
} from '@roz/models';

// Or use default export
import * as models from '@roz/models';
```

## Development Commands

```bash
# Build the package
npm run build

# Watch mode (rebuilds on file changes)
npm run dev

# Type check only
npm run check-types
```

## Future Enhancements

Planned additions to this package:

- [ ] Company model and operations
- [ ] User digest model and operations
- [ ] User follow model and operations
- [ ] Bulk insert/update operations
- [ ] Query helpers and filters
- [ ] Upsert operations with conflict handling
- [ ] Validation utilities for card data

## Related Packages

- **@roz/supabase**: Database schema, migrations, and TypeScript types (source of truth for types)
- **apps/harvester**: Main application that uses these models in workflows and agents
