# @roz/supabase Package

## Overview
This package manages the Supabase database for the Roz project, including migrations, TypeScript types, and database configuration. It's a private package within the Turborepo monorepo.

## Package Structure
```
packages/supabase/
├── config.toml           # Supabase local dev configuration
├── migrations/           # SQL migration files (timestamped)
├── src/
│   ├── client.ts         # Supabase client instance
│   ├── index.ts          # Main package exports (client + types)
│   └── types/
│       ├── database.types.ts  # Auto-generated Supabase types
│       └── index.ts           # Re-exports all types
├── package.json
└── tsconfig.json
```

## Database Schema

### Core Tables

#### `company`
Stores basic company information for companies users can follow.
- `id` (text, PK) - Company identifier
- `name` (text) - Company name
- `website` (text) - Company website URL
- `linkedin_url` (text, nullable) - LinkedIn profile
- `blog_url` (text, nullable) - Company blog URL
- `created_at` (timestamp) - Record creation time

#### `company_weekly_card`
Weekly digest cards for companies, containing news and updates.
- `card_id` (text, PK) - Unique card identifier
- `company_id` (text, FK → company.id) - Associated company
- `week_id` (text) - Week identifier
- `headline` (text) - Card headline
- `bullets_json` (jsonb) - Array of bullet points (max 160 chars each)
- `coverage_top` (text) - Top coverage/news item
- `significance_max` (number) - Maximum significance score
- `source_context` (text, nullable) - Source context information
- `version` (number) - Card version number
- `created_at`, `updated_at` (timestamps)

#### `user_digest`
User-specific weekly digest emails.
- `id` (serial, PK) - Auto-incrementing digest ID
- `user_id` (text) - User identifier
- `week_id` (text) - Week identifier
- `subject` (text) - Email subject line
- `preheader` (text, nullable) - Email preheader text
- `summary_paragraph` (text, nullable) - Summary paragraph
- `top_highlights_json` (jsonb, nullable) - Top highlights data
- `company_order` (text[], nullable) - Ordered list of company IDs
- `html` (text, nullable) - Rendered HTML email
- `text_fallback` (text, nullable) - Plain text version
- `template_version` (number) - Email template version
- `sent_at` (timestamp, nullable) - When email was sent
- `created_at` (timestamp)

#### `user_digest_card`
Join table linking digests to company cards.
- `digest_id` (number, FK → user_digest.id)
- `card_id` (text, FK → company_weekly_card.card_id)
- `position` (number) - Card position in digest

#### `user_follow_company`
Tracks which companies users follow.
- `user_id` (text)
- `company_id` (text, FK → company.id)
- `created_at` (timestamp)

### Database Functions

#### `bullet_lengths_valid(bullets jsonb) → boolean`
Validates that all bullet points in a JSON array are ≤ 160 characters.
- Used as a CHECK constraint on `company_weekly_card.bullets_json`

#### `set_updated_at() → trigger`
Trigger function to automatically update `updated_at` timestamp on row modifications.
- Applied to `company_weekly_card` table

## Migration System

### Migration Naming Convention
`YYYYMMDDHHMMSS_description.sql`

Example: `20251030140003_company.sql`

### Current Migrations (in order)
1. `20251030140001_extensions.sql` - Database extensions setup
2. `20251030140002_functions.sql` - Shared utility functions
3. `20251030140003_company.sql` - Company table
4. `20251030140004_company_weekly_card.sql` - Weekly card table
5. `20251030140005_user_digest.sql` - User digest table
6. `20251030140006_user_follow_company.sql` - User follow table
7. `20251030140007_default_privileges.sql` - Default privileges setup

### Migration Pattern
Each migration follows this structure:
1. Table/function definition
2. Set owner to `postgres`
3. Grant permissions to: `anon`, `authenticated`, `service_role`

## TypeScript Types

### Type Generation
Types are auto-generated by Supabase CLI and should NOT be manually edited.

### Available Types
- `Database` - Full database schema type
- `Json` - Recursive JSON type
- `Tables<TableName>` - Get Row type for a table
- `TablesInsert<TableName>` - Get Insert type for a table
- `TablesUpdate<TableName>` - Get Update type for a table
- `Enums<EnumName>` - Get enum type (none currently defined)
- `CompositeTypes<TypeName>` - Get composite type (none currently defined)
- `Constants` - Constant values from schema

### Usage Example
```typescript
import type { Database, Tables } from '@roz/supabase/types';

type Company = Tables<'company'>;
type CompanyInsert = TablesInsert<'company'>;
```

## Configuration

### Local Development
- Project ID: `roz`
- API Port: `54321`
- DB Port: `54322`
- Studio Port: `54323`
- Major Version: Postgres 17

### API Configuration
- Exposed schemas: `public`, `graphql_public`
- Extra search path: `public`, `extensions`
- Max rows: 1000

## Package Exports

```json
{
  ".": {
    "types": "./dist/index.d.ts",
    "default": "./dist/index.js"
  },
  "./types": {
    "types": "./dist/types/index.d.ts",
    "default": "./dist/types/index.js"
  }
}
```

### Using the Supabase Client

Import the pre-configured Supabase client:

```typescript
import { supabase } from '@roz/supabase';
import type { TablesInsert } from '@roz/supabase/types';

// Example: Insert a company weekly card
const cardData: TablesInsert<'company_weekly_card'> = {
  card_id: 'factory-ai__2025-W44',
  company_id: 'factory-ai',
  week_id: '2025-W44',
  headline: 'New partnership + product launch',
  bullets_json: ['• Partnership — ...', '• Product — ...'],
  // ...
};

const { data, error } = await supabase
  .from('company_weekly_card')
  .insert(cardData);
```

**Important**: The database uses **snake_case** column names (e.g., `card_id`, `company_id`), while the application layer uses **camelCase** (e.g., `cardId`, `companyId`). Always convert between these naming conventions when interfacing with the database.

## Seeding the Database

For local development, seed data is provided in `supabase/seed/seed.sql`.

### Seed Data Includes
- **User**: nduncan@mba2026.hbs.edu (password: `password123`)
  - User ID: `f7b3c3e0-9f0a-4b5e-8d3c-1a2b3c4d5e6f`
- **Companies**: 3 companies
  - Factory AI (`factory-ai`) - https://factory.ai
  - Juicebox (`juicebox`) - https://juicebox.ai
  - OpenAI (`openai`) - https://openai.com
- **Follows**: User automatically follows all 3 companies

### Running Seeds

**Recommended method** (auto-runs on db reset):
```bash
cd packages/supabase
supabase db reset
```

**Manual method** (run seed file directly):
```bash
psql -U postgres -d postgres -h localhost -p 54322 -f seed.sql
```

### Customizing Seed Data
To add more companies or modify existing ones, edit `supabase/seed/seed.sql` and update the company records with:
- Company ID (e.g., `anthropic`, `openai`) - kebab-case slug
- Company name
- Website URL
- LinkedIn profile URL
- Blog URL

Then run `supabase db reset` to apply the changes.

## Important Notes

1. **Type Generation**: To regenerate types after schema changes, use the Supabase CLI
2. **Permissions**: All tables grant full access to `anon`, `authenticated`, and `service_role`
3. **RLS**: Currently, RLS (Row Level Security) is NOT enabled - consider adding for production
4. **Bullet Points**: The `bullets_json` field has a validation constraint (160 char max per bullet)
5. **Timestamps**: `company_weekly_card` has auto-updating `updated_at` via trigger

## Future Considerations

- [ ] Add Row Level Security (RLS) policies
- [ ] Consider adding indexes for common queries
- [ ] Consider adding database functions for common operations
- [ ] Add enum types if needed for fixed value sets
